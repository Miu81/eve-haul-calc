<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dacia Hauling Co. - EVE Haul Calculator</title>
  <script>
    // Configuration rates
    const rates = {
      BR: { hs: 1250000, ls: 3000000 },
      Freighter: { hs: 1750000, ls: 4000000 },
      JF: { baseJump: 200000000, fuelPerJump: 30000000, cynoCost: 5000000 },
      DST: { hs: 100000000, ls: 150000000 }
    };
    const collateralMultiplier = (collateral) => {
      if (collateral < 5e8) return 1;
      if (collateral <= 2e9) return 1.5;
      return 2;
    };
    const profitMargins = {
      standard: 1.5,  // 50% margin internally
      express: 1.25   // 25% margin for outsourced
    };

    async function calculate() {
      const from = document.getElementById('from').value.trim();
      const to = document.getElementById('to').value.trim();
      const ship = document.getElementById('ship').value;
      const collateral = parseFloat(document.getElementById('collateral').value) || 0;
      const deliveryType = document.getElementById('delivery').value; // standard or express
      const output = document.getElementById('output');
      output.textContent = 'Calculating...';

      // Helper: fetch system ID (non-strict search)
      const fetchId = async (name) => {
        const res = await fetch(
          `https://esi.evetech.net/latest/search/?search=${encodeURIComponent(name)}&categories=solar_system&language=en`
        );
        const data = await res.json();
        return data.solar_system && data.solar_system[0];
      };

      try {
        const fromId = await fetchId(from);
        const toId = await fetchId(to);
        if (!fromId || !toId) throw new Error();
        const routeRes = await fetch(
          `https://esi.evetech.net/latest/route/${fromId}/${toId}/?datasource=tranquility`);
        if (!routeRes.ok) throw new Error();
        const route = await routeRes.json();
        const jumps = route.length;

        // Validate volume
        const volume = parseFloat(document.getElementById('volume').value) || 0;
        const volumeLimits = { BR:10000, Freighter:360000, JF:320000, DST:62500 };
        if (volume > volumeLimits[ship]) {
          output.textContent = `Error: ${ship} capacity is ${volumeLimits[ship]} m³.`;
          return;
        }

        // Calculate base cost
        let costBeforeMargin;
        if (ship === 'JF') {
          const base = rates.JF.baseJump * jumps;
          const fuel = rates.JF.fuelPerJump * jumps;
          const cyno = rates.JF.cynoCost;
          costBeforeMargin = base + fuel + cyno;
        } else {
          // determine zone by first system of route (simplified)
          const zone = 'hs';
          const rate = zone === 'hs' ? rates[ship].hs : rates[ship].ls;
          costBeforeMargin = rate * jumps * collateralMultiplier(collateral);
        }

        // Apply profit margin internally
        const margin = profitMargins[deliveryType];
        const totalCost = Math.round(costBeforeMargin * margin);

        // Display result without revealing margins
        output.textContent =
          `Route: ${from} → ${to} (${jumps} jumps)\n` +
          `Ship: ${ship}\n` +
          `Collateral: ${collateral.toLocaleString()} ISK\n` +
          `Delivery: ${deliveryType === 'standard' ? 'Standard' : 'Express'}\n` +
          `Estimated Cost: ${totalCost.toLocaleString()} ISK`;
      } catch (err) {
        output.textContent = 'Unable to calculate route. Please check system names.';
      }
    }
  </script>
</head>
<body class="p-4">
  <h1 class="text-xl font-bold mb-4">Dacia Hauling Co. – EVE Haul Calculator</h1>
  <div class="space-y-2">
    <input id="from" placeholder="From System" class="border p-1 w-full" />
    <input id="to" placeholder="To System" class="border p-1 w-full" />
    <select id="ship" class="border p-1 w-full">
      <option value="BR">Blockade Runner (BR)</option>
      <option value="Freighter">Freighter</option>
      <option value="JF">Jump Freighter (JF)</option>
      <option value="DST">Deep Space Transport (DST)</option>
    </select>
    <input id="volume" placeholder="Volume (m³)" type="number" class="border p-1 w-full" />
    <input id="collateral" placeholder="Collateral (ISK)" type="number" class="border p-1 w-full" />
    <select id="delivery" class="border p-1 w-full">
      <option value="standard">Standard Delivery</option>
      <option value="express">Express Delivery</option>
    </select>
    <button onclick="calculate()" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded">Calculate Cost</button>
  </div>
  <pre id="output" class="mt-4 p-2 border bg-gray-100"></pre>
</body>
</html>
